name: Enhanced Android CI

on:
  push:
    branches: [ main, master, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2

jobs:
  lint:
    name: Lint Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission
      run: chmod +x gradlew

    - name: Run Lint
      run: ./gradlew lintDevDebug lintProdRelease --stacktrace

    - name: Upload Lint Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: lint-reports
        path: app/build/reports/lint/
        retention-days: 14

    - name: Publish Lint Results
      if: always()
      uses: github/super-linter@v5
      env:
        DEFAULT_BRANCH: main
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        VALIDATE_KOTLIN: true

  unit-test:
    name: Unit Tests & Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission
      run: chmod +x gradlew

    - name: Run Unit Tests
      run: ./gradlew testDevDebugUnitTest testProdDebugUnitTest --stacktrace

    - name: Generate Coverage Report
      if: always()
      run: ./gradlew jacocoTestReport

    - name: Upload Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: app/build/reports/tests/
        retention-days: 14

    - name: Upload Coverage Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports
        path: app/build/reports/jacoco/
        retention-days: 14

    - name: Publish Test Results
      if: always()
      uses: EnricoMi/publish-unit-test-result-action@v2
      with:
        files: app/build/test-results/**/*.xml

    - name: Codecov Upload
      if: always()
      uses: codecov/codecov-action@v4
      with:
        files: ./app/build/reports/jacoco/jacocoTestReport/jacocoTestReport.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  build:
    name: Build APKs
    runs-on: ubuntu-latest
    timeout-minutes: 45

    strategy:
      matrix:
        variant:
          - devDebug
          - devStaging
          - prodDebug
          - prodStaging

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission
      run: chmod +x gradlew

    - name: Build ${{ matrix.variant }}
      run: ./gradlew assemble${{ matrix.variant }} --stacktrace

    - name: Upload ${{ matrix.variant }} APK
      uses: actions/upload-artifact@v4
      with:
        name: apk-${{ matrix.variant }}
        path: app/build/outputs/apk/**/*.apk
        retention-days: 30

  security:
    name: Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Run Dependency Analysis
      run: |
        chmod +x gradlew
        ./gradlew dependencies > build/dependencies.txt

    - name: Upload Dependency Report
      uses: actions/upload-artifact@v4
      with:
        name: dependencies
        path: build/dependencies.txt
        retention-days: 14

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [lint, unit-test, build, security]
    if: always()

    steps:
    - name: Check Quality Gate
      run: |
        echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Job Results" >> $GITHUB_STEP_SUMMARY
        echo "- Lint: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Unit Tests: ${{ needs.unit-test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Security: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.build.result }}" != "success" ]; then
          echo "❌ Quality gate failed!" >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "✅ Quality gate passed!" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "⚠️  Lint warnings present" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.unit-test.result }}" != "success" ]; then
            echo "⚠️  Unit test warnings present" >> $GITHUB_STEP_SUMMARY
          fi
        fi
