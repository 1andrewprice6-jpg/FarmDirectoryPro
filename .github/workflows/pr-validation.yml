name: Pull Request Validation

on:
  pull_request:
    branches: [ main, master, develop ]
    types: [opened, synchronize, reopened]

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission
      run: chmod +x gradlew

    - name: Run Lint Checks
      run: ./gradlew lintDevDebug --stacktrace

    - name: Upload Lint Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: lint-results
        path: app/build/reports/lint/
        retention-days: 7

    - name: Analyze Lint Results
      if: always()
      run: |
        if [ -f app/build/reports/lint/lint-results.xml ]; then
          echo "### Lint Results" >> $GITHUB_STEP_SUMMARY
          errors=$(grep -c 'severity="Error"' app/build/reports/lint/lint-results.xml || echo "0")
          warnings=$(grep -c 'severity="Warning"' app/build/reports/lint/lint-results.xml || echo "0")
          echo "- Errors: $errors" >> $GITHUB_STEP_SUMMARY
          echo "- Warnings: $warnings" >> $GITHUB_STEP_SUMMARY
        fi

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission
      run: chmod +x gradlew

    - name: Run Unit Tests
      run: ./gradlew testDevDebugUnitTest --stacktrace

    - name: Generate Coverage Report
      if: always()
      run: ./gradlew jacocoTestReport

    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: app/build/reports/tests/
        retention-days: 7

    - name: Upload Coverage Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: app/build/reports/jacoco/
        retention-days: 7

    - name: Add Coverage to PR
      if: always()
      uses: madrapps/jacoco-report@v1.6.1
      with:
        paths: app/build/reports/jacoco/jacocoTestReport/jacocoTestReport.xml
        token: ${{ secrets.GITHUB_TOKEN }}
        min-coverage-overall: 40
        min-coverage-changed-files: 60
        title: Code Coverage Report

  instrumentation-tests:
    name: Instrumentation Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission
      run: chmod +x gradlew

    - name: Build Android Test APK
      run: ./gradlew assembleDevDebugAndroidTest

    - name: Run Instrumentation Tests
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 30
        target: google_apis
        arch: x86_64
        profile: Nexus 6
        script: ./gradlew connectedDevDebugAndroidTest --stacktrace

    - name: Upload Instrumentation Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: instrumentation-test-results
        path: app/build/reports/androidTests/
        retention-days: 7

  build-validation:
    name: Build Validation
    runs-on: ubuntu-latest

    strategy:
      matrix:
        variant: [devDebug, devRelease, prodDebug, prodStaging]

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission
      run: chmod +x gradlew

    - name: Build ${{ matrix.variant }}
      run: ./gradlew assemble${{ matrix.variant }} --stacktrace

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: apk-${{ matrix.variant }}
        path: app/build/outputs/apk/**/*.apk
        retention-days: 7

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission
      run: chmod +x gradlew

    - name: Run Dependency Check
      run: |
        ./gradlew dependencies > dependencies.txt
        echo "### Dependency Tree Generated" >> $GITHUB_STEP_SUMMARY

    - name: OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      id: depcheck
      with:
        project: 'FarmDirectory'
        path: '.'
        format: 'HTML'
        args: >
          --enableRetired
          --enableExperimental

    - name: Upload Security Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: reports/
        retention-days: 7

  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests, build-validation]
    if: always()

    steps:
    - name: PR Summary
      run: |
        echo "## Pull Request Validation Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Job Status" >> $GITHUB_STEP_SUMMARY
        echo "- Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Unit Tests: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Build Validation: ${{ needs.build-validation.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Check the artifacts for detailed reports." >> $GITHUB_STEP_SUMMARY
